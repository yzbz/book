###RDB持久化与AOF持久化
####Redis提供了两种持久化方式

* RDB持久化（快照）
* AOF持久化（只追加操作的文件 Append-only file）

1.RDB持久化

   RDB持久化是指在客户端输入save、bgsave或者达到配置文件自动保存快照条件时，将Redis 在内存中的数据生成快照保存在名字为 dump.rdb（文件名可修改）的二进制文件中。
   
save命令
```
    save命令会阻塞Redis服务器进程，直到RDB文件创建完毕为止，在Redis服务器阻塞期间，服务器不能处理任何命令请求。
```
       
bgsave命令的工作原理如下
```
    服务器进程pid为1349派生出一个pid为1357的子进程，
    子进程将数据写入到一个临时 RDB 文件中
    当子进程完成对新 RDB 文件的写入时，Redis 用新 RDB 文件替换原来的 RDB 文件，并删除旧的 RDB 文件。    
    注：bgsave命令执行期间
    SAVE命令会被拒绝
    不能同时执行两个BGSAVE命令
    不能同时执行BGREWRITEAOF和BGSAVE命令
```
    
自动保存
```
这个需要在配置文件redis.conf中修改，默认的保存策略如下
    
    save 900 1    # 900 秒内有至少有 1 个键被改动
    save 300 10   # 300 秒内有至少有 10 个键被改动
    save 60 10000 # 60 秒内有至少有 1000 个键被改动
```
    
* 优点<br>
```
RDB是一个非常紧凑（有压缩）的文件,它保存了某个时间点的数据,非常适用于数据的备份。
RDB作为一个非常紧凑（有压缩）的文件，可以很方便传送到另一个远端数据中心 ，非常适用于灾难恢复.
RDB在保存RDB文件时父进程唯一需要做的就是fork出一个子进程,接下来的工作全部由子进程来做，父进程不需要再做其他IO操作，所以RDB持久化方式可以最大化redis的性能.
与AOF相比,在恢复大的数据集的时候，RDB方式会更快一些.
```

    
* 缺点<br>
```
Redis意外宕机 时，会丢失部分数据
当Redis数据量比较大时，fork的过程是非常耗时的，fork子进程时是会阻塞的，在这期间Redis 是不能响应客户端的请求的。
```

2.AOF持久化

AOF持久化是通过保存Redis服务器所执行的写命令来记录数据库状态，也就是每当 Redis 执行一个改变数据集的命令时（比如 SET）， 这个命令就会被追加到 AOF 文件的末尾。

开启AOF持久化
修改redis.conf配置文件，默认是appendonly no（关闭状态），将no改为yes即可

    appendonly yes
在客户端输入如下命令也可，但是Redis服务器重启后会失效

    192.168.17.101:6379> config set appendonly yes
    OK
实现

AOF持久化功能的实现可以分为命令追加（append）、文件写入和文件同步（sync）三个步骤。

    文件写入：只是写入到了内存缓冲区，可能还没有写到文件所拥有的磁盘数据块上
    文件同步：将缓冲区中的内容冲洗到磁盘上
为什么将文件写入和文件同步合在一块讲呢？因为配置文件中提供了一个appendfsync参数，这个参数控制着文件写入和同步的行为。

|  appendfsync选项的值|效果|
|  :----  | ----  |
| always  | 每次有新命令时，就将缓冲区数据写入并同步到 AOF 文件 |
| everysec （默认） | 每秒将缓冲区的数据写入并同步到 AOF 文件 |
| no  | 将缓冲区数据写入AOF 文件，但是同步操作到交给操作系统来处理 |

  